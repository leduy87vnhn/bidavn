import React, { useEffect, useState } from 'react';
import axios from 'axios';
import { TextField, Button, Grid, Typography, Box, Select, MenuItem } from '@mui/material';
import '../css/personalMember.scss';

const PersonalMemberTab = () => {
  const [player, setPlayer] = useState(null);
  const [isEditing, setIsEditing] = useState(false);
  const [frontPhoto, setFrontPhoto] = useState(null);
  const [backPhoto, setBackPhoto] = useState(null);
  const [facePhoto, setFacePhoto] = useState(null);

  const [userPhone, setUserPhone] = useState('');
  const [showConfirm, setShowConfirm] = useState(false);
  const [tempData, setTempData] = useState(null);
  const [originalPlayer, setOriginalPlayer] = useState(null);

  const [frontPhotoFile, setFrontPhotoFile] = useState(null);
  const [backPhotoFile, setBackPhotoFile] = useState(null);
  const [facePhotoFile, setFacePhotoFile] = useState(null);

  const [frontPreview, setFrontPreview] = useState(null);
  const [backPreview, setBackPreview] = useState(null);
  const [facePreview, setFacePreview] = useState(null);

  const disciplineText =
    player?.discipline === 1 ? 'Pool'
    : player?.discipline === 0 ? 'Carom'
    : '‚Äî';

  useEffect(() => {
    const user = JSON.parse(localStorage.getItem('user_info'));
    if (user?.phone_number) {
      setUserPhone(user.phone_number);
      fetchPlayer(user.phone_number);
    }
  }, []);

  const fetchPlayer = async (phone) => {
    try {
      const res = await axios.get(`/api/members/me?phone=${phone}`);
      console.log('üì¶ D·ªØ li·ªáu player tr·∫£ v·ªÅ:', res.data); // üëà Th√™m log n√†y
      if (res.data) {
        setPlayer(res.data);
        setOriginalPlayer(res.data); // <-- th√™m d√≤ng n√†y
      }
    } catch (err) {
      console.error('‚ùå L·ªói khi g·ªçi API /api/members/me:', err);
    }
  };

  // Helper chuy·ªÉn ƒë∆∞·ªùng d·∫´n DB th√†nh URL h·ª£p l·ªá
  const effectivePhotoSrc = (dbValue) => {
    if (!dbValue) return null;
    return dbValue.includes('/') ? `/${dbValue.replace(/^\//, '')}` : `/uploads/players/${dbValue}`;
  };

  // Cell ·∫£nh d√πng trong Grid
  const ImageCell = ({ label, kind, dbField }) => {
    const preview = (kind === 'face') ? facePreview
                  : (kind === 'front') ? frontPreview
                  : (kind === 'back') ? backPreview : null;
    const dbPath = player[dbField] ? effectivePhotoSrc(player[dbField]) : null;

    return (
      <Grid item xs={12} sm={6} md={4}>
        <Typography fontWeight="bold" mb={1}>{label}</Typography>
        {isEditing ? (
          <>
            <Button variant="outlined" component="label">
              Duy·ªát ·∫¢nh
              <input type="file" accept="image/*" hidden onChange={(e) => handleFileChange(e, kind)} />
            </Button>
            {(preview || dbPath) && (
              <div style={{ marginTop: 8 }}>
                <img
                  src={preview || dbPath}
                  alt={label}
                  style={{ width: '100%', maxHeight: 180, objectFit: 'contain', borderRadius: 8, cursor: 'zoom-in' }}
                  onClick={() => window.open(preview || dbPath, '_blank')}
                />
                {preview && <div style={{ fontStyle: 'italic', marginTop: 4 }}>(* ·∫¢nh m·ªõi ‚Äì ch·ªâ hi·ªÉn th·ªã tr∆∞·ªõc khi l∆∞u)</div>}
              </div>
            )}
          </>
        ) : (
          dbPath ? (
            <img
              src={dbPath}
              alt={label}
              onClick={() => window.open(dbPath, '_blank')}
              style={{ width: '100%', maxHeight: 180, objectFit: 'contain', cursor: 'zoom-in', borderRadius: 8 }}
            />
          ) : <div style={{ fontStyle: 'italic' }}>Ch∆∞a c√≥ ·∫£nh</div>
        )}
      </Grid>
    );
  };

  const handleFileChange = (e, kind) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    if (kind === 'front') { setFrontPhotoFile(file); setFrontPreview(url); }
    if (kind === 'back')  { setBackPhotoFile(file);  setBackPreview(url); }
    if (kind === 'face')  { setFacePhotoFile(file);  setFacePreview(url); }
  };

  const handleEditToggle = () => {
    setOriginalPlayer(player);  // l∆∞u b·∫£n g·ªëc ƒë·ªÉ h·ªßy
    setIsEditing(true);
  };

  const handleUpdate = async () => {
    const formData = new FormData();
    formData.append('id', player.id);
    formData.append('name', player.name);
    formData.append('address', player.address || '');
    formData.append('citizen_id_passport', player.citizen_id_passport || '');

    if (frontPhoto) formData.append('citizen_id_front_photo', frontPhoto);
    if (backPhoto) formData.append('citizen_id_back_photo', backPhoto);
    if (facePhoto) formData.append('face_photo', facePhoto);

    await axios.put('/api/members/update-player', formData);
    setIsEditing(false);
    setFrontPhoto(null);
    setBackPhoto(null);
    setFacePhoto(null);
    fetchPlayer(userPhone);
  };

  // [TH√äM] ‚Äì resize (gi·ªëng Register.js)
const resizeImage = (file, maxWidth = 1000, quality = 0.85) =>
  new Promise((resolve, reject) => {
    try {
      const img = new Image();
      const reader = new FileReader();

      reader.onload = (e) => {
        img.onload = () => {
          const scale = Math.min(1, maxWidth / img.width);
          const w = Math.round(img.width * scale);
          const h = Math.round(img.height * scale);

          const canvas = document.createElement('canvas');
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);

          canvas.toBlob(
            (blob) => {
              if (!blob) return reject(new Error('Canvas toBlob failed'));
              const out = new File([blob], file.name.replace(/\.\w+$/i, '.jpg'), {
                type: 'image/jpeg',
              });
              resolve(out);
            },
            'image/jpeg',
            quality
          );
        };
        img.onerror = reject;
        img.src = e.target.result;
      };

      reader.onerror = reject;
      reader.readAsDataURL(file);
    } catch (err) {
      reject(err);
    }
  });
  // [TH√äM] ‚Äì upload ·∫£nh t·ªõi /api/players/upload-photo
  const API = process.env.REACT_APP_API_BASE_URL || '';

  const uploadImage = async (file, phone, type) => {
    if (!file) return null;
    const ext = (file.name && file.name.includes('.')) ? file.name.split('.').pop() : 'jpg';
    let filename = '';
    if (type === 'face') filename = `${phone}_face_photo.${ext}`;
    if (type === 'cccd_front') filename = `${phone}_citizen_id_front_photo.${ext}`;
    if (type === 'cccd_back')  filename = `${phone}_citizen_id_back_photo.${ext}`;

    let finalFile = file;
    if (file.size > 1024 * 1024) {
      try { finalFile = await resizeImage(file); } catch { finalFile = file; }
    }
    const renamed = new File([finalFile], filename, { type: finalFile.type || 'image/jpeg' });

    const formData = new FormData();
    formData.append('file', renamed);

    const res = await axios.post(`${API}/api/players/upload-photo`, formData);
    return res.data?.filePath || null; // "uploads/players/xxx.jpg"
  };

  const saveAll = async () => {
    if (!player?.id) { alert('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ID h·ªôi vi√™n.'); return; }
    try {
      // 1) Upload ·∫£nh m·ªõi n·∫øu c√≥
      let citizen_id_front_photo = player.citizen_id_front_photo || null;
      let citizen_id_back_photo  = player.citizen_id_back_photo || null;
      let face_photo             = player.face_photo || null;

      if (frontPhotoFile) {
        const p = await uploadImage(frontPhotoFile, player.phone || userPhone, 'cccd_front');
        if (p) citizen_id_front_photo = p;
      }
      if (backPhotoFile) {
        const p = await uploadImage(backPhotoFile, player.phone || userPhone, 'cccd_back');
        if (p) citizen_id_back_photo = p;
      }
      if (facePhotoFile) {
        const p = await uploadImage(facePhotoFile, player.phone || userPhone, 'face');
        if (p) face_photo = p;
      }

      // 2) PUT c·∫≠p nh·∫≠t player v√†o DB
      const payload = {
        name: (player.name || '').toUpperCase(),
        phone: player.phone || 'unknown',
        ranking: player.ranking || 0,
        points: player.points || 0,
        pool_ranking: player.pool_ranking || 0,
        pool_points: player.pool_points || 0,
        modified_date: new Date().toISOString(),
        gender: player.gender ?? 0,
        birth_day: player.birth_day || null,
        citizen_id_passport: player.citizen_id_passport || '',
        member_status: player.member_status ?? 1,
        member_fee_status: player.member_fee_status ?? 0,
        address: player.address || '',
        competition_unit: player.competition_unit || '',
        discipline: player.discipline ?? 0,
        citizen_id_front_photo,
        citizen_id_back_photo,
        face_photo
      };

      await axios.put(`${API}/api/players/${player.id}`, payload);

      alert('‚úÖ ƒê√£ l∆∞u th√¥ng tin!');
      setIsEditing(false);
      // clear file & preview
      setFrontPhotoFile(null); setFrontPreview(null);
      setBackPhotoFile(null);  setBackPreview(null);
      setFacePhotoFile(null);  setFacePreview(null);

      fetchPlayer(userPhone);
    } catch (err) {
      console.error('‚ùå L·ªói l∆∞u:', err);
      alert('‚ùå L∆∞u th·∫•t b·∫°i.');
    }
  };

  const handleRegister = () => {
    if (!player?.phone || !player.name || !player.citizen_id_passport || !player.citizen_id_front_photo || !player.citizen_id_back_photo || !player.face_photo) {
      alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin v√† ·∫£nh tr∆∞·ªõc khi ƒëƒÉng k√Ω!');
      return;
    }
    // G·ª≠i y√™u c·∫ßu ƒëƒÉng k√Ω (t√πy y√™u c·∫ßu, backend s·∫Ω x·ª≠ l√Ω)
    alert('ƒê√£ g·ª≠i y√™u c·∫ßu ƒëƒÉng k√Ω!');
  };

  const handleCancel = () => {
    //setTempData(player);  // Reset d·ªØ li·ªáu v·ªÅ l·∫°i nh∆∞ c≈©
    setPlayer(tempData);
    setIsEditing(false);  // Tho√°t ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
  };

  const handleRegisterConfirm = async () => {
      if (!player?.phone || !player.name || !player.citizen_id_passport || !player.citizen_id_front_photo || !player.citizen_id_back_photo || !player.face_photo) {
          alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin v√† ·∫£nh tr∆∞·ªõc khi ƒëƒÉng k√Ω!');
          setShowConfirm(false);
          return;
      }

      try {
          await axios.post('/api/members/register-member', { id: player.id });
          alert('‚úÖ ƒê√£ ƒëƒÉng k√Ω h·ªôi vi√™n th√†nh c√¥ng!');
          setShowConfirm(false);
          fetchPlayer(userPhone); // reload l·∫°i th√¥ng tin m·ªõi
      } catch (err) {
          console.error('ƒêƒÉng k√Ω th·∫•t b·∫°i:', err);
          alert('‚ùå C√≥ l·ªói khi ƒëƒÉng k√Ω h·ªôi vi√™n.');
      }

      // TODO: g·ª≠i y√™u c·∫ßu ƒëƒÉng k√Ω h·ªôi vi√™n th·∫≠t s·ª± (API ho·∫∑c c·∫≠p nh·∫≠t status)
      alert('‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu ƒëƒÉng k√Ω!');
      setShowConfirm(false);
  };

  if (!player) {
    return <Typography>Kh√¥ng c√≥ th√¥ng tin h·ªôi vi√™n c√° nh√¢n.</Typography>;
  }

  const renderImage = (label, field, fileSetter) => (
    <Grid item xs={12} sm={6} md={4}>
      <Typography fontWeight="bold" mb={1}>{label}</Typography>
      {isEditing ? (
        <Button variant="outlined" component="label">
          Duy·ªát ·∫¢nh
          <input type="file" accept="image/*" hidden onChange={(e) => handleFileChange(e, field)} />
        </Button>
      ) : (
        player[field] && (
          <img
            src={player[field].includes('/') ? `/${player[field]}` : `/uploads/players/${player[field]}`}
            alt={label}
            onClick={() => window.open(`/uploads/players/${player[field]}`, '_blank')}
            style={{ width: '100%', maxHeight: 180, objectFit: 'contain', cursor: 'zoom-in', borderRadius: 8 }}
          />
        )
      )}
    </Grid>
  );

  return (
    <Box className="personal-member-container">
      <div className="section-title">H·ªòI VI√äN C√Å NH√ÇN</div>

      {/* D√≤ng th√¥ng tin */}
      <div className="info-row">
        <label>S·ªë ƒëi·ªán tho·∫°i:</label>
        <div className="value-box">
          {isEditing ? (
            <TextField
              size="small"
              value={player.phone || ''}
              onChange={(e) =>
                setPlayer({ ...player, phone: e.target.value.replace(/\D/g, '').slice(0, 10) })
              }
              inputProps={{ inputMode: 'numeric', maxLength: 10 }}
            />
          ) : (player.phone || '‚Äî')}
        </div>

        <label>H·ªç v√† t√™n:</label>
        <div className="value-box">
          {isEditing ? (
            <TextField
              size="small"
              value={player.name || ''}
              onChange={(e) =>
                setPlayer({ ...player, name: (e.target.value || '').toUpperCase() })
              }
            />
          ) : (player.name || '‚Äî')}
        </div>
      </div>

      <div className="info-row">
        <label>Gi·ªõi t√≠nh:</label>
        <div className="value-box">
          {isEditing ? (
            <Select
              size="small"
              value={player.gender ?? 0}
              onChange={(e) =>
                setPlayer({ ...player, gender: Number(e.target.value) })
              }
            >
              <MenuItem value={0}>Nam</MenuItem>
              <MenuItem value={1}>N·ªØ</MenuItem>
              <MenuItem value={2}>Kh√°c</MenuItem>
            </Select>
          ) : (player.gender === 1 ? 'N·ªØ' : player.gender === 2 ? 'Kh√°c' : 'Nam')}
        </div>

        <label>Ng√†y sinh:</label>
        <div className="value-box">
          {isEditing ? (
            <TextField
              type="date"
              size="small"
              value={player.birth_day ? new Date(player.birth_day).toISOString().slice(0, 10) : ''}
              onChange={(e) =>
                setPlayer({ ...player, birth_day: e.target.value })
              }
            />
          ) : (player.birth_day ? new Date(player.birth_day).toLocaleDateString('vi-VN') : '‚Äî')}
        </div>
      </div>

      <div className="info-row">
        <label>S·ªë CCCD / H·ªô chi·∫øu:</label>
        <div className="value-box">
          {isEditing ? (
            <TextField
              size="small"
              value={player.citizen_id_passport || ''}
              onChange={(e) =>
                setPlayer({ ...player, citizen_id_passport: e.target.value })
              }
            />
          ) : (player.citizen_id_passport || '‚Äî')}
        </div>

        <label>ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫:</label>
        <div className="value-box" style={{ flex: 2 }}>
          {isEditing ? (
            <TextField
              size="small"
              fullWidth
              value={player.address || ''}
              onChange={(e) =>
                setPlayer({ ...player, address: e.target.value })
              }
            />
          ) : (player.address || '‚Äî')}
        </div>
      </div>

      <div className="info-row">
        <label>ƒê∆°n v·ªã thi ƒë·∫•u:</label>
        <div className="value-box">
          {isEditing ? (
            <TextField
              size="small"
              value={player.competition_unit || ''}
              onChange={(e) =>
                setPlayer({ ...player, competition_unit: e.target.value })
              }
            />
          ) : (player.competition_unit || '‚Äî')}
        </div>

        <label>Tr·∫°ng th√°i:</label>
        <div className="value-box">
          {isEditing ? (
            <Select
              size="small"
              value={player.member_status ?? 1}
              onChange={(e) =>
                setPlayer({ ...player, member_status: Number(e.target.value) })
              }
            >
              <MenuItem value={1}>T·ª± do/H·ªôi vi√™n</MenuItem>
              <MenuItem value={0}>Ch∆∞a ƒëƒÉng k√Ω</MenuItem>
            </Select>
          ) : (
            <span className="status-box">
              {player.member_status === 1 ? 'T·ª± do/H·ªôi vi√™n' : 'Ch∆∞a ƒëƒÉng k√Ω'}
            </span>
          )}
        </div>
      </div>

      {/* ·∫¢nh 4x6 */}
      {/* <div className="photo-side">
        <div className="label">·∫¢nh 4x6</div>
        {player.face_photo ? (
          <img
            src={`/uploads/players/${player.face_photo}`}
            alt="·∫¢nh 4x6"
            onClick={() => window.open(`/uploads/players/${player.face_photo}`, '_blank')}
          />
        ) : (
          <div style={{ fontStyle: 'italic' }}>Ch∆∞a c√≥ ·∫£nh</div>
        )}
      </div> */}
      <Grid container spacing={2}>
        <ImageCell label="·∫¢nh 4x6" kind="face"  dbField="face_photo" />
        <ImageCell label="CCCD m·∫∑t tr∆∞·ªõc" kind="front" dbField="citizen_id_front_photo" />
        <ImageCell label="CCCD m·∫∑t sau"   kind="back"  dbField="citizen_id_back_photo" />
      </Grid>

      {/* N√∫t */}
      <div className="action-buttons">
        {/* {!isEditing ? (
          <Button variant="outlined" onClick={() => setIsEditing(true)}>ƒêI·ªÄU CH·ªàNH</Button>
        ) : (
          <Button variant="contained" onClick={handleUpdate}>C·∫¨P NH·∫¨T</Button>
        )} */}
        {isEditing ? (
          <>
            <button onClick={handleUpdate}>üíæ L∆∞u</button>
            <button onClick={handleCancel} style={{ marginLeft: '10px', backgroundColor: '#ccc' }}>‚ùå H·ªßy</button>
          </>
        ) : (
          <button onClick={() => {
            setTempData({ ...player }); // L∆∞u b·∫£n sao
            setIsEditing(true);
          }}>
            üõ†Ô∏è ƒêi·ªÅu ch·ªânh
          </button>        
        )}
      </div>

      {/* Ph·∫ßn "Th√¥ng tin chuy√™n m√¥n" n·∫øu c·∫ßn */}
      <div className="info-row">
        <label>N·ªôi dung thi ƒë·∫•u:</label>
        <div className="value-box">
          {isEditing ? (
            <Select
              size="small"
              value={player.discipline ?? 0}
              onChange={(e) =>
                setPlayer({ ...player, discipline: Number(e.target.value) })
              }
            >
              <MenuItem value={0}>Carom</MenuItem>
              <MenuItem value={1}>Pool</MenuItem>
            </Select>
          ) : (player.discipline === 1 ? 'Pool' : player.discipline === 0 ? 'Carom' : '‚Äî')}
        </div>

        <label>ƒêi·ªÉm s·ªë:</label>
        <div className="value-box">
          {isEditing ? (
            <TextField
              size="small"
              value={player.discipline === 1 ? (player.pool_points || '') : (player.points || '')}
              onChange={(e) => {
                const v = e.target.value.replace(/[^\d]/g, '');
                if (player.discipline === 1)
                  setPlayer({ ...player, pool_points: v });
                else
                  setPlayer({ ...player, points: v });
              }}
            />
          ) : (player.discipline === 1 ? player.pool_points || '‚Äî' : player.points || '‚Äî')}
        </div>

        <label>Th·ª© h·∫°ng:</label>
        <div className="value-box">
          {isEditing ? (
            <TextField
              size="small"
              value={player.discipline === 1 ? (player.pool_ranking || '') : (player.ranking || '')}
              onChange={(e) => {
                const v = e.target.value.replace(/[^\d]/g, '');
                if (player.discipline === 1)
                  setPlayer({ ...player, pool_ranking: v });
                else
                  setPlayer({ ...player, ranking: v });
              }}
            />
          ) : (player.discipline === 1 ? player.pool_ranking || '‚Äî' : player.ranking || '‚Äî')}
        </div>
      </div>
    </Box>
  );
};

export default PersonalMemberTab;